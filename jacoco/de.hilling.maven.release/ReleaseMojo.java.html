<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReleaseMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">The Multi Module Maven Release Plugin</a> &gt; <a href="index.source.html" class="el_package">de.hilling.maven.release</a> &gt; <span class="el_source">ReleaseMojo.java</span></div><h1>ReleaseMojo.java</h1><pre class="source lang-java linenums">package de.hilling.maven.release;

import static de.hilling.maven.release.Reactor.fromProjects;
import static java.util.Collections.emptyList;
import static java.util.Collections.singletonList;

import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.apache.maven.model.Scm;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugin.logging.Log;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.shared.invoker.DefaultInvocationRequest;
import org.apache.maven.shared.invoker.DefaultInvoker;
import org.eclipse.jgit.api.errors.GitAPIException;

import de.hilling.maven.release.releaseinfo.ReleaseInfoStorage;
import de.hilling.maven.release.repository.LocalGitRepo;
import de.hilling.maven.release.versioning.ImmutableReleaseInfo;
import de.hilling.maven.release.versioning.ReleaseDateSingleton;
import de.hilling.maven.release.versioning.ReleaseInfo;

/**
 * Releases the project.
 */
@Mojo(name = &quot;release&quot;, requiresDirectInvocation = true,
      // this should not be bound to a phase as this plugin starts a phase itself
      inheritByDefault = true, // so you can configure this in a shared parent pom
      requiresProject = true, // this can only run against a maven project
      aggregator = true // the plugin should only run once against the aggregator pom
      )
<span class="fc" id="L37">public class ReleaseMojo extends BaseMojo {</span>

    /**
     * &lt;p&gt;
     * Profiles to activate during the release.
     * &lt;/p&gt;
     * &lt;p&gt;
     * Note that if any profiles are activated during the build using the `-P` or `--activate-profiles` will also be activated during release.
     * This gives two options for running releases: either configure it in the plugin configuration, or activate profiles from the command line.
     * &lt;/p&gt;
     *
     * @since 1.0.1
     */
<span class="fc" id="L50">    @Parameter(alias = &quot;releaseProfiles&quot;)</span>
<span class="fc" id="L51">    private       List&lt;String&gt; releaseProfiles = emptyList();</span>
    /**
     * &lt;p&gt;
     * The goals to run against the project before the release. By default this is &quot;test&quot; which
     * means the project is built and the tests are run.
     * &lt;/p&gt;
     * &lt;p&gt;
     * You can specify more goals and maven options. For example if you want to perform
     * a clean install, use:
     * &lt;/p&gt;
     * &lt;pre&gt;
     * {@code
     * &lt;testGoals&gt;
     *     &lt;testGoals&gt;clean&lt;/testGoals&gt;
     *     &lt;testGoals&gt;install&lt;/testGoals&gt;
     * &lt;/testGoals&gt;
     * }
     * &lt;/pre&gt;
     * &lt;p&gt;
     * Remember that you will most probably do an implicit &quot;compile package install deploy&quot; during the release phase.
     * &lt;/p&gt;
     */
<span class="fc" id="L73">    @Parameter(alias = &quot;testGoals&quot;)</span>
<span class="fc" id="L74">    private List&lt;String&gt; testGoals    = emptyList();</span>
    /**
     * &lt;p&gt;
     * Profiles to activate during the the test run.
     * &lt;/p&gt;
     * &lt;p&gt;
     * Note that if any profiles are activated during the build using the `-P` or `--activate-profiles` will also be
     * activated during test.
     * This gives two options for running test: either configure it in the plugin configuration, or activate profiles
     * from the command line.
     * &lt;/p&gt;
     *
     * @since 1.0.1
     */
<span class="fc" id="L88">    @Parameter(alias = &quot;testProfiles&quot;)</span>
<span class="fc" id="L89">    private List&lt;String&gt; testProfiles = emptyList();</span>
    /**
     * Determines running of tests. Possible values:
     * {@code testPhaseOnly}, {@code runAlways}, {@code skipTests}
     */
    @Parameter(alias = &quot;testBehaviour&quot;, defaultValue = &quot;testPhaseOnly&quot;, property = &quot;testBehaviour&quot;)
    private TestBehaviour testBehaviour;
    /**
     * &lt;p&gt;
     * The goals to run against the project during a release. By default this is &quot;deploy&quot; which
     * means the release version of your artifact will be tested and deployed.
     * &lt;/p&gt;
     * &lt;p&gt;
     * You can specify more goals and maven options. For example if you want to perform
     * a clean, build a maven site, and then deploy it, use:
     * &lt;/p&gt;
     * &lt;pre&gt;
     * {@code
     * &lt;releaseGoals&gt;
     *     &lt;releaseGoal&gt;clean&lt;/releaseGoal&gt;
     *     &lt;releaseGoal&gt;site&lt;/releaseGoal&gt;
     *     &lt;releaseGoal&gt;deploy&lt;/releaseGoal&gt;
     * &lt;/releaseGoals&gt;
     * }
     * &lt;/pre&gt;
     */
<span class="fc" id="L115">    @Parameter(alias = &quot;releaseGoals&quot;)</span>
<span class="fc" id="L116">    private List&lt;String&gt; releaseGoals = emptyList();</span>
    /**
     * Push changes to remote repository. This includes:
     * &lt;ul&gt;
     * &lt;li&gt;The newly created tag for this release containing the release information&lt;/li&gt;
     * &lt;li&gt;The release info file containing the same information. This will be used to find relevant older
     * releases to compare to during the following release.&lt;/li&gt;
     * &lt;/ul&gt;
     */
    @Parameter(alias = &quot;push&quot;, defaultValue = &quot;true&quot;, property = &quot;push&quot;)
    private boolean push;

    private static List&lt;File&gt; updatePomsAndReturnChangedFiles(Log log, LocalGitRepo repo, Reactor reactor) throws
                                                                                                           MojoExecutionException,
                                                                                                           ValidationException {
<span class="fc" id="L131">        PomUpdater pomUpdater = new PomUpdater(log, reactor);</span>
<span class="fc" id="L132">        PomUpdater.UpdateResult result = pomUpdater.updateVersion();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (!result.success()) {</span>
<span class="fc" id="L134">            log.info(&quot;Going to revert changes because there was an error.&quot;);</span>
<span class="fc" id="L135">            repo.revertChanges(log, result.alteredPoms);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            if (result.unexpectedException != null) {</span>
<span class="fc" id="L137">                throw new ValidationException(&quot;Unexpected exception while setting the release versions in the pom&quot;,</span>
                                              result.unexpectedException);
            } else {
<span class="fc" id="L140">                String summary = &quot;Cannot release with references to snapshot dependencies&quot;;</span>
<span class="fc" id="L141">                List&lt;String&gt; messages = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L142">                messages.add(summary);</span>
<span class="fc" id="L143">                messages.add(&quot;The following dependency errors were found:&quot;);</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">                for (String dependencyError : result.dependencyErrors) {</span>
<span class="fc" id="L145">                    messages.add(&quot; * &quot; + dependencyError);</span>
<span class="fc" id="L146">                }</span>
<span class="fc" id="L147">                throw new ValidationException(summary, messages);</span>
            }
        }
<span class="fc" id="L150">        return result.alteredPoms;</span>
    }

    @Override
    public void executeConcreteMojo(Scm scm, Scm originalScm, LocalGitRepo repo) throws MojoExecutionException,
                                                                                        MojoFailureException,
                                                                                        GitAPIException {
<span class="fc" id="L157">        setDefaults();</span>
<span class="fc" id="L158">        repo.errorIfNotClean();</span>

<span class="fc" id="L160">        final ReleaseInfoStorage infoStorage = new ReleaseInfoStorage(project.getBasedir(), repo.git);</span>
<span class="fc" id="L161">        ReleaseInfo previousRelease = infoStorage.load();</span>
<span class="fc" id="L162">        getLog().info(&quot;previous release: &quot; + previousRelease);</span>

<span class="fc" id="L164">        Reactor reactor = fromProjects(getLog(), repo, project, projects, modulesToForceRelease, noChangesAction,</span>
                                       bugfixRelease, previousRelease);
<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (reactor == null) {</span>
<span class="fc" id="L167">            return;</span>
        }

<span class="fc" id="L170">        final List&lt;ReleasableModule&gt; releasableModules = reactor.getModulesInBuildOrder();</span>

<span class="fc" id="L172">        final ImmutableReleaseInfo.Builder releaseBuilder = ImmutableReleaseInfo.builder().tagName(</span>
<span class="fc" id="L173">            ReleaseDateSingleton.getInstance().tagName());</span>

<span class="fc" id="L175">        List&lt;String&gt; modulesToRelease = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">        for (ReleasableModule releasableModule : releasableModules) {</span>
<span class="fc" id="L177">            releaseBuilder.addModules(releasableModule.getImmutableModule());</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (releasableModule.isToBeReleased()) {</span>
<span class="fc" id="L179">                modulesToRelease.add(releasableModule.getRelativePathToModule());</span>
            }
<span class="fc" id="L181">        }</span>

<span class="fc" id="L183">        final ImmutableReleaseInfo currentRelease = releaseBuilder.build();</span>
<span class="fc" id="L184">        getLog().info(&quot;current release: &quot; + currentRelease);</span>

<span class="fc" id="L186">        List&lt;File&gt; changedFiles = updatePomsAndReturnChangedFiles(getLog(), repo, reactor);</span>

<span class="fc bfc" id="L188" title="All 2 branches covered.">        if (testBehaviour != TestBehaviour.skipPreRelease) {</span>
            try {
<span class="fc" id="L190">                final PhaseInvoker invoker = new PhaseInvoker(getLog(), project, new DefaultInvocationRequest(),</span>
                                                                   new DefaultInvoker(), testGoals, testProfiles,
<span class="fc" id="L192">                                                                   getSettings(),</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">                                                                   !testBehaviour.isRunInTestPhase());</span>
<span class="fc" id="L194">                invoker.runMavenBuild(reactor);</span>
<span class="fc" id="L195">                infoStorage.store(currentRelease);</span>
<span class="fc" id="L196">            } catch (MojoExecutionException mee) {</span>
<span class="fc" id="L197">                revertChanges(repo, changedFiles, false);</span>
<span class="fc" id="L198">                throw mee;</span>
<span class="fc" id="L199">            }</span>
        }

<span class="fc" id="L202">        tagAndPushRepo(repo, currentRelease);</span>

        try {
<span class="fc" id="L205">            final PhaseInvoker invoker = new PhaseInvoker(getLog(), project, new DefaultInvocationRequest(),</span>
<span class="fc" id="L206">                                                          new DefaultInvoker(), releaseGoals, releaseProfiles, getSettings(),</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">                                                          !testBehaviour.isRunInReleasePhase());</span>
<span class="fc" id="L208">            invoker.runMavenBuild(reactor);</span>
<span class="fc" id="L209">            revertChanges(repo, changedFiles, true); // throw if you can't revert as that is the root problem</span>
        } finally {
<span class="pc" id="L211">            revertChanges(repo, changedFiles,</span>
                          false); // warn if you can't revert but keep throwing the original exception so the root cause isn't lost
<span class="fc" id="L213">        }</span>
<span class="fc" id="L214">    }</span>

    private void setDefaults() {
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">        if (testGoals.isEmpty()) {</span>
<span class="fc" id="L218">            testGoals = singletonList(&quot;test&quot;);</span>
        }
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (releaseGoals.isEmpty()) {</span>
<span class="nc" id="L221">            releaseGoals = singletonList(&quot;deploy&quot;);</span>
        }
<span class="fc" id="L223">    }</span>

    private void tagAndPushRepo(LocalGitRepo repo, ImmutableReleaseInfo releaseInfo) throws GitAPIException {
<span class="fc" id="L226">        final Optional&lt;String&gt; optionalTag = releaseInfo.getTagName();</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (optionalTag.isPresent()) {</span>
<span class="fc" id="L228">            final AnnotatedTag tag = new AnnotatedTag(optionalTag.get(), releaseInfo);</span>

<span class="fc" id="L230">            getLog().info(&quot;About to tag repository with &quot; + releaseInfo.toString());</span>
<span class="fc" id="L231">            repo.tagRepo(tag);</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">            if (push) {</span>
<span class="fc" id="L233">                getLog().info(&quot;About to push tags &quot; + tag.name());</span>
<span class="fc" id="L234">                repo.pushAll();</span>
            }
<span class="fc" id="L236">        } else {</span>
<span class="nc" id="L237">            throw new ValidationException(&quot;internal error: no tag found on release info &quot; + releaseInfo);</span>
        }
<span class="fc" id="L239">    }</span>

    private void revertChanges(LocalGitRepo repo, List&lt;File&gt; changedFiles, boolean throwIfError) throws
                                                                                                 MojoExecutionException {
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">        if (!repo.revertChanges(getLog(), changedFiles)) {</span>
<span class="nc" id="L244">            String message = &quot;Could not revert changes - working directory is no longer clean. Please revert changes manually&quot;;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (throwIfError) {</span>
<span class="nc" id="L246">                throw new MojoExecutionException(message);</span>
            } else {
<span class="nc" id="L248">                getLog().warn(message);</span>
            }
        }
<span class="fc" id="L251">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>